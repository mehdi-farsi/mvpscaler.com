<%# app/views/landing/_field_input.html.erb %>
<%# locals: field_key (e.g. "copy.headline"), template:, landing: %>
<%
  meta      = template.fields[field_key] || {}
  label     = meta["label"].presence || field_key.split(".").last.humanize
  type      = meta["type"].to_s
  rows      = (meta["rows"].presence || 3).to_i
  choices   = Array(meta["choices"])
  # Current value from landing.settings; fallback to template default
  # field_key is flat "bucket.path", so we split to dig
  bucket, *rest = field_key.split(".")
  current = landing.settings.dig(bucket, *rest)
  current = LandingTemplate.defaults_for(landing.template_key).dig(bucket, *rest) if current.nil?
%>

<div class="mb-4">
  <label class="block text-sm font-medium text-gray-700 mb-1"><%= label %></label>

  <% case type %>
  <% when "text" %>
    <input type="text"
           name="settings_flat[<%= field_key %>]"
           value="<%= current.to_s %>"
           class="block w-full rounded-lg border bg-white px-3 py-2 text-gray-900 placeholder-gray-400 shadow-sm transition
                  focus:outline-none focus:ring-4 focus:ring-emerald-500/30 focus:border-emerald-500 border-gray-300" />

  <% when "longtext" %>
    <textarea name="settings_flat[<%= field_key %>]"
              rows="<%= rows %>"
              class="block w-full rounded-lg border bg-white px-3 py-2 text-gray-900 placeholder-gray-400 shadow-sm transition
                     focus:outline-none focus:ring-4 focus:ring-emerald-500/30 focus:border-emerald-500 border-gray-300"><%= current.to_s %></textarea>

  <% when "color" %>
    <div class="flex items-center gap-2">
      <input type="color"
             value="<%= current.to_s.presence || '#ffffff' %>"
             class="h-9 w-12 rounded border border-gray-300"
             oninput="this.nextElementSibling.value=this.value; this.nextElementSibling.dispatchEvent(new Event('input'))" />
      <input type="text"
             name="settings_flat[<%= field_key %>]"
             value="<%= current.to_s %>"
             placeholder="#RRGGBB"
             class="flex-1 rounded-lg border bg-white px-3 py-2 text-gray-900 placeholder-gray-400 shadow-sm transition
                    focus:outline-none focus:ring-4 focus:ring-emerald-500/30 focus:border-emerald-500 border-gray-300" />
    </div>

  <% when "image_asset" %>
    <%# Opinionated: pick from known asset choices, show a preview thumbnail %>
    <div class="flex items-center gap-3">
      <div class="w-24 h-16 rounded border border-gray-200 overflow-hidden bg-gray-50">
        <% if current.present? %>
          <img src="<%= image_path(current) %>" alt="" class="w-full h-full object-cover">
        <% else %>
          <div class="w-full h-full grid place-items-center text-xs text-gray-400">no image</div>
        <% end %>
      </div>

      <div class="flex-1">
        <% if choices.any? %>
          <select name="settings_flat[<%= field_key %>]"
                  class="block w-full rounded-lg border bg-white px-3 py-2 text-gray-900 shadow-sm transition
                         focus:outline-none focus:ring-4 focus:ring-emerald-500/30 focus:border-emerald-500 border-gray-300">
            <option value=""></option>
            <% choices.each do |fn| %>
              <option value="<%= fn %>" <%= "selected" if current.to_s == fn %>><%= fn %></option>
            <% end %>
          </select>
        <% else %>
          <input type="text"
                 name="settings_flat[<%= field_key %>]"
                 value="<%= current.to_s %>"
                 placeholder="asset filename (e.g., hero-bg.webp)"
                 class="block w-full rounded-lg border bg-white px-3 py-2 text-gray-900 placeholder-gray-400 shadow-sm transition
                        focus:outline-none focus:ring-4 focus:ring-emerald-500/30 focus:border-emerald-500 border-gray-300" />
        <% end %>
        <p class="mt-1 text-xs text-gray-500">Pick an asset shipped with the template.</p>
      </div>
    </div>

  <% else %>
    <%# default to text %>
    <input type="text"
           name="settings_flat[<%= field_key %>]"
           value="<%= current.to_s %>"
           class="block w-full rounded-lg border bg-white px-3 py-2 text-gray-900 placeholder-gray-400 shadow-sm transition
                  focus:outline-none focus:ring-4 focus:ring-emerald-500/30 focus:border-emerald-500 border-gray-300" />
  <% end %>
</div>
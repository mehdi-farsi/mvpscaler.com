<%# app/views/landing/_field_input.html.erb %>
<%# locals: field_key (e.g. "copy.headline"), template:, landing: %>
<%
  meta      = template.fields[field_key].stringify_keys || {}
  label     = meta["label"].presence || field_key.split(".").last.humanize
  type      = meta["type"].to_s
  rows      = (meta["rows"].presence || 3).to_i
  choices   = Array(meta["choices"])
  # Current value from landing.settings; fallback to template default
  # field_key is flat "bucket.path", so we split to dig
  bucket, *rest = field_key.split(".")
  current = landing.settings.dig(bucket, *rest)
  current = LandingTemplate.defaults_for(landing.template_key).dig(bucket, *rest) if current.nil?
  pp ?2*100, meta, label, type, rows, choices,  bucket, current
%>

<div class="mb-4">
  <label class="block text-sm font-medium text-gray-700 mb-1"><%= label %> </label>

  <% case type %>
  <% when "text" %>
    <input type="text"
           name="settings_flat[<%= field_key %>]"
           value="<%= current.to_s %>"
           class="block w-full rounded-lg border bg-white px-3 py-2 text-gray-900 placeholder-gray-400 shadow-sm transition
                  focus:outline-none focus:ring-4 focus:ring-emerald-500/30 focus:border-emerald-500 border-gray-300" />

  <% when "longtext" %>
    <textarea name="settings_flat[<%= field_key %>]"
              rows="<%= rows %>"
              class="block w-full rounded-lg border bg-white px-3 py-2 text-gray-900 placeholder-gray-400 shadow-sm transition
                     focus:outline-none focus:ring-4 focus:ring-emerald-500/30 focus:border-emerald-500 border-gray-300"><%= current.to_s %></textarea>

  <% when "color" %>
    <div class="flex items-center gap-2">
      <input type="color"
             value="<%= current.to_s.presence || '#ffffff' %>"
             class="h-9 w-12 rounded border border-gray-300"
             oninput="this.nextElementSibling.value=this.value; this.nextElementSibling.dispatchEvent(new Event('input'))" />
      <input type="text"
             name="settings_flat[<%= field_key %>]"
             value="<%= current.to_s %>"
             placeholder="#RRGGBB"
             class="flex-1 rounded-lg border bg-white px-3 py-2 text-gray-900 placeholder-gray-400 shadow-sm transition
                    focus:outline-none focus:ring-4 focus:ring-emerald-500/30 focus:border-emerald-500 border-gray-300" />
    </div>

  <% when "image_asset" %>
    <%# Build a filename => URL map so previews work with fingerprinted assets %>
    <% url_map = choices.any? ? choices.index_with { |fn| image_path(fn) } : {} %>

    <div class="mb-4"
         data-controller="landing-editor"
         data-landing-editor-url-map-value="<%= url_map.to_json %>"
         data-landing-editor-field>
      <label class="block text-sm font-medium text-gray-700 mb-1"><%= label %></label>

      <div class="flex items-center gap-3">
        <div class="w-28 h-18 rounded border border-gray-200 overflow-hidden bg-gray-50 shrink-0">
          <% initial_src =
               if current.blank?
                 ""
               elsif current.to_s.start_with?("http", "/")
                 current
               elsif url_map[current.to_s]
                 url_map[current.to_s]
               else
                 image_path(current.to_s)
               end %>

          <img
            data-landing-editor-target="imagePreview"
            src="<%= initial_src %>"
            alt="<%= current.presence || 'no image' %>"
            class="w-full h-full object-cover"
            onerror="this.src=''; this.alt='no image';">
        </div>

        <div class="flex-1">
          <% if choices.any? %>
            <select
              name="settings_flat[<%= field_key %>]"
              data-landing-editor-target="imageInput"
              data-action="input->landing-editor#updateImage change->landing-editor#updateImage"
              class="block w-full rounded-lg border bg-white px-3 py-2 text-gray-900 shadow-sm transition
                   focus:outline-none focus:ring-4 focus:ring-emerald-500/30 focus:border-emerald-500 border-gray-300">
              <option value=""></option>
              <% choices.each do |fn| %>
                <option value="<%= fn %>" <%= "selected" if current.to_s == fn %>><%= fn %></option>
              <% end %>
            </select>
            <p class="mt-1 text-xs text-gray-500">Choose a bundled asset. Preview updates instantly.</p>
          <% else %>
            <input type="text"
                   name="settings_flat[<%= field_key %>]"
                   value="<%= current.to_s %>"
                   placeholder="e.g., hero-bg.webp or https://â€¦"
                   data-landing-editor-target="imageInput"
                   data-action="input->landing-editor#updateImage change->landing-editor#updateImage"
                   class="block w-full rounded-lg border bg-white px-3 py-2 text-gray-900 placeholder-gray-400 shadow-sm transition
                        focus:outline-none focus:ring-4 focus:ring-emerald-500/30 focus:border-emerald-500 border-gray-300" />
            <p class="mt-1 text-xs text-gray-500">Enter a filename shipped with the app or a full URL.</p>
          <% end %>
        </div>
      </div>
    </div>

  <% else %>
    <%# default to text %>
    <input type="text"
           name="settings_flat[<%= field_key %>]"
           value="<%= current.to_s %>"
           class="block w-full rounded-lg border bg-white px-3 py-2 text-gray-900 placeholder-gray-400 shadow-sm transition
                  focus:outline-none focus:ring-4 focus:ring-emerald-500/30 focus:border-emerald-500 border-gray-300" />
  <% end %>
</div>
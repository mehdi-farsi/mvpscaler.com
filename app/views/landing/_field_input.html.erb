<%# app/views/landing/_field_input.html.erb %>
<%# locals: field_key (e.g. "copy.headline"), template:, landing: %>
<%
  meta        = (template.fields[field_key] || {}).stringify_keys
  label       = meta["label"].presence || field_key.split(".").last.humanize
  type        = meta["type"].to_s.presence || "text"
  rows        = (meta["rows"].presence || 3).to_i
  choices     = Array(meta["choices"])
  placeholder = meta["placeholder"]
  hint_text   = meta["hint"]
  min         = meta["min"]
  max         = meta["max"]
  step        = meta["step"]

  # Current value (landing.settings -> template default)
  bucket, *rest = field_key.split(".")
  current = landing.settings.dig(bucket, *rest)
  current = LandingTemplate.defaults_for(landing.template_key).dig(bucket, *rest) if current.nil?

  # Compact input classes
  compact_input  = "h-9 text-[13px] px-3 rounded-md ring-1 ring-inset ring-gray-300 focus:ring-emerald-500 bg-white text-gray-900 placeholder-gray-400 focus:outline-none transition w-full"
  compact_select = compact_input
%>

<div class="grid grid-cols-[160px_1fr] items-start gap-4" data-landing-editor-field>
  <label class="text-[13px] font-medium text-gray-700 mt-2"><%= label %></label>

  <%# ───────────────────────── TEXT / LONGTEXT / NUMBER / URL ───────────────────────── %>
  <% if %w[text longtext number url].include?(type) %>
    <% if type == "longtext" %>
      <textarea
        name="settings_flat[<%= field_key %>]"
        rows="<%= rows %>"
        placeholder="<%= placeholder %>"
        class="<%= [compact_input, 'min-h-[88px]'].join(' ') %>"><%= current.to_s %></textarea>
    <% else %>
      <input
        type="<%= type == 'number' ? 'number' : (type == 'url' ? 'url' : 'text') %>"
        name="settings_flat[<%= field_key %>]"
        value="<%= current.to_s %>"
        placeholder="<%= placeholder %>"
        <%= %(min="#{min}") if min.present? %>
        <%= %(max="#{max}") if max.present? %>
        <%= %(step="#{step}") if step.present? %>
        class="<%= compact_input %>" />
    <% end %>

    <% if hint_text.present? %>
      <p class="col-span-2 text-xs text-gray-500 ml-[160px]"><%= hint_text %></p>
    <% end %>

    <%# ───────────────────────── SELECT (explicit or inferred by choices) ───────────────────────── %>
  <% elsif type == "select" || (choices.any? && type != "image_asset") %>
    <select
      name="settings_flat[<%= field_key %>]"
      class="<%= compact_select %>">
      <option value=""></option>
      <% choices.each do |opt| %>
        <% text, value = opt.is_a?(Array) ? opt : [opt, opt] %>
        <option value="<%= value %>" <%= "selected" if current.to_s == value.to_s %>><%= text %></option>
      <% end %>
    </select>
    <% if hint_text.present? %>
      <p class="col-span-2 text-xs text-gray-500 ml-[160px]"><%= hint_text %></p>
    <% end %>

    <%# ───────────────────────── COLOR ───────────────────────── %>
  <% elsif type == "color" %>
    <div class="flex items-center gap-3">
      <input
        type="color"
        value="<%= current.to_s.presence || '#ffffff' %>"
        class="h-8 w-10 rounded border border-gray-300"
        oninput="this.nextElementSibling.value=this.value; this.nextElementSibling.dispatchEvent(new Event('input'))" />
      <input
        type="text"
        name="settings_flat[<%= field_key %>]"
        value="<%= current.to_s %>"
        placeholder="<%= placeholder.presence || '#RRGGBB' %>"
        class="<%= compact_input %>" />
    </div>
    <% if hint_text.present? %>
      <p class="col-span-2 text-xs text-gray-500 ml-[160px]"><%= hint_text %></p>
    <% end %>

    <%# ───────────────────────── BOOLEAN / TOGGLE ───────────────────────── %>
  <% elsif %w[boolean toggle].include?(type) %>
    <% checked = ActiveModel::Type::Boolean.new.cast(current) %>
    <label class="inline-flex items-center gap-3 cursor-pointer">
      <input type="hidden" name="settings_flat[<%= field_key %>]" value="0" />
      <input type="checkbox"
             name="settings_flat[<%= field_key %>]"
             value="1"
             <%= "checked" if checked %>
             class="peer sr-only" />
      <span class="h-5 w-10 rounded-full bg-gray-300 ring-1 ring-inset ring-gray-200 relative transition
                   after:content-[''] after:absolute after:top-0.5 after:left-0.5 after:h-4 after:w-4 after:rounded-full after:bg-white after:shadow after:transition
                   peer-checked:bg-emerald-600 peer-checked:after:translate-x-5"></span>
    </label>
    <% if hint_text.present? %>
      <p class="col-span-2 text-xs text-gray-500 ml-[160px]"><%= hint_text %></p>
    <% end %>

    <%# ───────────────────────── IMAGE ASSET (preview + select/text + upload) ───────────────────────── %>
  <% elsif type == "image_asset" %>
    <% url_map = (choices.presence || []).index_with { |fn| image_path(fn) } rescue {} %>
    <% preview_url = landing.asset_url_for(field_key).presence || "" %>

    <div data-controller="landing-editor"
         data-landing-editor-url-map-value="<%= url_map.to_json %>"
         class="flex items-center gap-3">
      <div class="w-28 h-16 overflow-hidden rounded-md bg-gray-100 ring-1 ring-gray-200 shrink-0">
        <img data-landing-editor-target="imagePreview"
             src="<%= preview_url %>"
             alt=""
             class="w-full h-full object-cover"
             onerror="this.src=''; this.classList.add('opacity-40')">
      </div>

      <div class="flex-1 flex items-center gap-3">
        <% if choices.any? %>
          <select
            name="settings_flat[<%= field_key %>]"
            data-landing-editor-target="imageInput"
            data-action="input->landing-editor#updateImage change->landing-editor#updateImage"
            class="<%= compact_select %>">
            <option value=""></option>
            <% choices.each do |fn| %>
              <option value="<%= fn %>" <%= "selected" if current.to_s == fn %>><%= fn %></option>
            <% end %>
          </select>
        <% else %>
          <input
            type="text"
            name="settings_flat[<%= field_key %>]"
            value="<%= current.to_s %>"
            placeholder="<%= placeholder.presence || 'hero-bg.webp or URL' %>"
            data-landing-editor-target="imageInput"
            data-action="input->landing-editor#updateImage change->landing-editor#updateImage"
            class="<%= compact_input %>" />
        <% end %>

        <button type="button"
                data-action="landing-editor#pickFile"
                class="text-[13px] h-9 px-3 inline-flex items-center gap-2 rounded-md ring-1 ring-gray-300 hover:bg-gray-50">
          <i class="bi bi-upload"></i> Upload
        </button>

        <input type="file"
               accept="image/*"
               name="uploads[<%= field_key %>]"
               data-landing-editor-target="fileInput"
               data-action="change->landing-editor#fileChosen"
               class="hidden" />
      </div>
    </div>
    <% if hint_text.present? %>
      <p class="col-span-2 text-xs text-gray-500 ml-[160px]"><%= hint_text %></p>
    <% end %>

    <%# ───────────────────────── DEFAULT (fallback to text) ───────────────────────── %>
  <% else %>
    <input
      type="text"
      name="settings_flat[<%= field_key %>]"
      value="<%= current.to_s %>"
      placeholder="<%= placeholder %>"
      class="<%= compact_input %>" />
    <% if hint_text.present? %>
      <p class="col-span-2 text-xs text-gray-500 ml-[160px]"><%= hint_text %></p>
    <% end %>
  <% end %>
</div>
